<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Simple File Sharing</title>
    <style>
        /* Mobile-first styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f7f7f7;
            color: #333;
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 500px;
            background-color: #fff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        h1, h2 {
            text-align: center;
            color: #1a1a1a;
            margin-top: 0;
        }

        .hidden {
            display: none;
        }

        input[type="file"], select, button {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        input[type="file"] {
            background-color: #f9f9f9;
        }

        button {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        
        .go-to-link-button {
            background-color: #28a745;
        }

        .go-to-link-button:hover {
            background-color: #218838;
        }
        
        .perma-link-button {
            background-color: #17a2b8;
        }
        
        .perma-link-button:hover {
            background-color: #138496;
        }

        .delete-button {
            background-color: #dc3545;
        }

        .delete-button:hover {
            background-color: #c82333;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        #shareable-link {
            word-break: break-all;
            background-color: #f0f4f7;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        #upload-status {
            text-align: center;
            margin-top: 15px;
            font-weight: 500;
            min-height: 1.2em;
        }

        a {
            color: #007bff;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        #file-viewer img, #file-viewer video, #file-viewer audio {
            max-width: 100%;
            height: auto;
            margin-top: 20px;
            display: block;
        }

        @media (min-width: 600px) {
            body {
                padding: 40px;
            }
        }

        /* Spinner styles */
        #loading-spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255,255,255,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #loading-spinner.visible {
            visibility: visible;
            opacity: 1;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #007bff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
    </style>
</head>
<body>

    <div id="loading-spinner">
        <div class="spinner"></div>
    </div>

    <div class="container" id="uploader">
        <h1>Upload a File</h1>
        <form id="upload-form">
            <label for="file-input">Choose your file:</label>
            <input type="file" id="file-input" required />

            <label for="expiration-date">Auto-Expiration:</label>
            <select id="expiration-date">
                <option value="3600">1 Hour</option>
                <option value="21600">6 Hours</option>
                <option value="86400">1 Day</option>
                <option value="259200">3 Days</option>
                <option value="604800">7 Days</option>
            </select>
            <button type="submit">Upload File</button>
        </form>
        <p id="upload-status"></p>
    </div>

    <div class="container hidden" id="sharer">
        <h2>Your File is Ready!</h2>
        <p>Share this link:</p>
        <div id="shareable-link"></div>
        <button onclick="copyLink()">Copy Link</button>
        <button class="go-to-link-button" onclick="goToLink()">Go to link</button>
    </div>

    <div class="container hidden" id="viewer">
        <h2 id="viewer-filename">File Information</h2>
        <div id="file-viewer"></div>
        <p id="expiration-info"><strong>Expires At:</strong> <span id="viewer-expires"></span></p>
        <p><strong>Uploaded At:</strong> <span id="viewer-uploaded"></span></p>
        <button id="perma-link-button" class="perma-link-button hidden" onclick="createPermaLink()">Create Perma Link</button>
        <button id="delete-file-button" class="delete-button hidden" onclick="deleteFile()">Delete File</button>
    </div>

    <div class="container hidden" id="downloader">
        <h2>File Download</h2>
        <p>Please wait, your download should start automatically.</p>
        <p>If not, <a id="download-link" href="#">click here</a>.</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://sarbeabfdlskvleyjbnd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhcmJlYWJmZGxza3ZsZXlqYm5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2MDUzMzgsImV4cCI6MjA3MDE4MTMzOH0.P_Q4zFN8qOWRbR5kvTZ6eAKIhFk5VDwx6RL8KvtCd_Y';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const uploaderSection = document.getElementById('uploader');
        const sharerSection = document.getElementById('sharer');
        const viewerSection = document.getElementById('viewer');
        const downloaderSection = document.getElementById('downloader');
        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');
        const expirationSelect = document.getElementById('expiration-date');
        const uploadStatus = document.getElementById('upload-status');
        const shareableLinkDiv = document.getElementById('shareable-link');
        const fileViewerDiv = document.getElementById('file-viewer');
        const viewerFilenameH2 = document.getElementById('viewer-filename');
        const viewerExpiresSpan = document.getElementById('viewer-expires');
        const viewerUploadedSpan = document.getElementById('viewer-uploaded');
        const expirationInfo = document.getElementById('expiration-info');
        const deleteFileButton = document.getElementById('delete-file-button');
        const permaLinkButton = document.getElementById('perma-link-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const SHARE_BASE_URL = 'https://githubuser102234.github.io/gif-converter/';

        // Show spinner
        function showLoading() {
            loadingSpinner.classList.add('visible');
        }
        // Hide spinner
        function hideLoading() {
            loadingSpinner.classList.remove('visible');
        }

        function generateRandomString(length = 8) {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Convert seconds to human readable time
        function secondsToReadable(sec) {
            if (sec < 60) return sec + ' seconds';
            if (sec < 3600) return Math.floor(sec / 60) + ' minutes';
            if (sec < 86400) return Math.floor(sec / 3600) + ' hours';
            return Math.floor(sec / 86400) + ' days';
        }

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!fileInput.files.length) {
                alert('Please select a file.');
                return;
            }
            showLoading();
            uploadStatus.textContent = '';
            sharerSection.classList.add('hidden');
            viewerSection.classList.add('hidden');
            downloaderSection.classList.add('hidden');

            const file = fileInput.files[0];
            const expirationSeconds = parseInt(expirationSelect.value);

            // Generate unique ID for file storage
            const fileId = generateRandomString(12);

            try {
                // Upload file to Supabase Storage
                const fileExt = file.name.split('.').pop();
                const filePath = `${fileId}.${fileExt}`;

                const { data, error: uploadError } = await supabase.storage
                    .from('files')
                    .upload(filePath, file);

                if (uploadError) throw uploadError;

                // Calculate expiration time (timestamp)
                const uploadedAt = Date.now();
                const expiresAt = uploadedAt + expirationSeconds * 1000;

                // Save metadata in Supabase DB table 'files' (if exists, else use localStorage fallback)
                // We'll try inserting/updating a record in 'files' table:
                const { data: insertData, error: dbError } = await supabase
                    .from('files')
                    .insert([{ id: fileId, file_path: filePath, uploaded_at: new Date(uploadedAt).toISOString(), expires_at: new Date(expiresAt).toISOString() }]);

                if (dbError) {
                    // If error, fallback to localStorage with expiration (simpler fallback)
                    localStorage.setItem(`filemeta_${fileId}`, JSON.stringify({
                        file_path: filePath,
                        uploaded_at: uploadedAt,
                        expires_at: expiresAt
                    }));
                }

                // Show share link
                const shareUrl = `${window.location.origin}${window.location.pathname}#${fileId}`;
                shareableLinkDiv.textContent = shareUrl;

                uploadStatus.textContent = 'Upload successful!';
                sharerSection.classList.remove('hidden');
            } catch (err) {
                uploadStatus.textContent = 'Upload failed: ' + err.message;
                console.error(err);
            } finally {
                hideLoading();
            }
        });

        // Copy link button
        function copyLink() {
            const text = shareableLinkDiv.textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Link copied to clipboard!');
            }).catch(() => {
                alert('Failed to copy the link.');
            });
        }

        // Go to link button
        function goToLink() {
            const url = shareableLinkDiv.textContent;
            window.location.href = url;
        }

        // On page load, check if there's a hash param, then show file viewer/download
        async function checkHashOnLoad() {
            const hash = window.location.hash.substring(1);
            if (!hash) return;

            showLoading();
            uploaderSection.classList.add('hidden');
            sharerSection.classList.add('hidden');
            viewerSection.classList.add('hidden');
            downloaderSection.classList.add('hidden');

            const fileId = hash;

            // Try to get metadata from DB or localStorage
            let meta = null;
            try {
                const { data, error } = await supabase.from('files').select().eq('id', fileId).single();
                if (error) throw error;
                meta = data;
            } catch {
                // fallback localStorage
                const localMeta = localStorage.getItem(`filemeta_${fileId}`);
                if (localMeta) {
                    meta = JSON.parse(localMeta);
                }
            }

            if (!meta) {
                alert('File metadata not found or expired.');
                uploaderSection.classList.remove('hidden');
                hideLoading();
                return;
            }

            // Check expiration
            let expiresAt = null;
            let uploadedAt = null;
            if (meta.expires_at) {
                expiresAt = new Date(meta.expires_at).getTime();
            } else if (meta.expires_at && typeof meta.expires_at === 'number') {
                expiresAt = meta.expires_at;
            }

            if (meta.uploaded_at) {
                uploadedAt = new Date(meta.uploaded_at).getTime();
            } else if (meta.uploaded_at && typeof meta.uploaded_at === 'number') {
                uploadedAt = meta.uploaded_at;
            }

            if (expiresAt && Date.now() > expiresAt) {
                alert('This file has expired and is no longer available.');
                uploaderSection.classList.remove('hidden');
                hideLoading();
                return;
            }

            // Get public URL from Supabase Storage
            const filePath = meta.file_path || meta.file_path;
            if (!filePath) {
                alert('File path missing.');
                uploaderSection.classList.remove('hidden');
                hideLoading();
                return;
            }

            // Get public URL (Supabase default bucket 'files' is public, so use getPublicUrl)
            const { data: publicUrlData } = supabase.storage.from('files').getPublicUrl(filePath);

            if (!publicUrlData || !publicUrlData.publicUrl) {
                alert('Failed to get file public URL.');
                uploaderSection.classList.remove('hidden');
                hideLoading();
                return;
            }

            // Show file info and preview if possible
            viewerFilenameH2.textContent = `File: ${filePath.split('/').pop()}`;

            viewerExpiresSpan.textContent = expiresAt ? new Date(expiresAt).toLocaleString() : 'No expiration';
            viewerUploadedSpan.textContent = uploadedAt ? new Date(uploadedAt).toLocaleString() : 'Unknown';

            // Clear previous viewer
            fileViewerDiv.innerHTML = '';

            // Determine file type by extension
            const ext = filePath.split('.').pop().toLowerCase();
            const imageTypes = ['jpg','jpeg','png','gif','webp','bmp'];
            const videoTypes = ['mp4','webm','ogg','mov'];
            const audioTypes = ['mp3','wav','ogg'];

            if (imageTypes.includes(ext)) {
                const img = document.createElement('img');
                img.src = publicUrlData.publicUrl;
                img.alt = "Uploaded image";
                fileViewerDiv.appendChild(img);
            } else if (videoTypes.includes(ext)) {
                const video = document.createElement('video');
                video.src = publicUrlData.publicUrl;
                video.controls = true;
                fileViewerDiv.appendChild(video);
            } else if (audioTypes.includes(ext)) {
                const audio = document.createElement('audio');
                audio.src = publicUrlData.publicUrl;
                audio.controls = true;
                fileViewerDiv.appendChild(audio);
            } else {
                // Just show a download link if unknown file type
                const link = document.createElement('a');
                link.href = publicUrlData.publicUrl;
                link.textContent = 'Download File';
                link.download = filePath.split('/').pop();
                fileViewerDiv.appendChild(link);
            }

            // Show perma link and delete button (for demo, show always)
            permaLinkButton.classList.remove('hidden');
            deleteFileButton.classList.remove('hidden');

            viewerSection.classList.remove('hidden');
            hideLoading();
        }

        async function createPermaLink() {
            alert('Perma link creation not implemented in this demo.');
        }

        async function deleteFile() {
            if (!confirm('Are you sure you want to delete this file? This action cannot be undone.')) return;
            showLoading();

            const fileId = window.location.hash.substring(1);
            if (!fileId) {
                alert('No file selected.');
                hideLoading();
                return;
            }

            // Get metadata first
            let meta = null;
            try {
                const { data, error } = await supabase.from('files').select().eq('id', fileId).single();
                if (error) throw error;
                meta = data;
            } catch {
                // fallback localStorage
                const localMeta = localStorage.getItem(`filemeta_${fileId}`);
                if (localMeta) {
                    meta = JSON.parse(localMeta);
                }
            }

            if (!meta) {
                alert('File metadata not found.');
                hideLoading();
                return;
            }

            // Delete from storage
            const { error: delError } = await supabase.storage.from('files').remove([meta.file_path]);
            if (delError) {
                alert('Failed to delete file from storage: ' + delError.message);
                hideLoading();
                return;
            }

            // Delete from DB
            await supabase.from('files').delete().eq('id', fileId);

            // Delete from localStorage fallback
            localStorage.removeItem(`filemeta_${fileId}`);

            alert('File deleted successfully.');
            // Redirect to main uploader view
            window.location.hash = '';
            location.reload();
        }

        window.onload = () => {
            checkHashOnLoad();
        }
    </script>

</body>
</html>